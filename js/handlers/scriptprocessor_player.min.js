/**
* Generic ScriptProcessor based WebAudio player. 
*
* This infrastructure consists of two parts:
*
* <p>SamplePlayer: The generic player which must be parameterized with a specific AudioBackendAdapterBase 
*                  subclass (which is not contained in this lib)
*
* <p>AudioBackendAdapterBase: an abstract base class for specific backend (i.e. 'sample data producer') integration.
*
*	version 1.1.5 (with WASM support, cached filename translation & track switch bugfix, "internal filename" 
*				mapping, getVolume, setPanning, AudioContext get/resume, AbstractTicker revisited, bugfix for 
*               duplicate events, improved "play after user gesture" support  + doubled sample buffer size),
*               support for use of "alias" names for same file (see modland), added EmsHEAPF32BackendAdapter,
*               added silence detection, extended copyTickerData signature, added JCH's "choppy ticker" fix,
*				added setSilenceTimeout(); added asyncSetFileData; added getTickToggle(), getBufNum() & getScriptProcessorBufSize()
*
* 	Copyright (C) 2022 Juergen Wothke
*
* Terms of Use: This software is licensed under a CC BY-NC-SA 
* (http://creativecommons.org/licenses/by-nc-sa/4.0/).
*/
var fetchSamples=function(a){var b=window.player.genSamples.bind(window.player);b(a)},calcTick=function(a){var b=window.player.tick.bind(window.player);b(a)},setGlobalWebAudioCtx=function(){if("undefined"==typeof window._gPlayerAudioCtx){try{"AudioContext"in window?window._gPlayerAudioCtx=new AudioContext:"webkitAudioContext"in window?window._gPlayerAudioCtx=new webkitAudioContext:alert("Web Audio API is not supported in this browser"+e)}catch(a){alert("Web Audio API is not supported in this browser"+a)}}try{"suspended"===window._gPlayerAudioCtx.state&&"ontouchstart"in window&&window._gPlayerAudioCtx.resume()}catch(a){}};function surrogateCtor(){}function extend(a,b,c){for(var d in surrogateCtor.prototype=a.prototype,b.prototype=new surrogateCtor,b.prototype.constructor=b,b.base=a,c)b.prototype[d]=c[d];return b}AbstractTicker=function(){},AbstractTicker.prototype={init:function(){},start:function(){},reset:function(){},computeAudioSamplesNotify:function(){},resampleData:function(){},copyTickerData:function(){},calcTickData:function(){}};var SAMPLES_PER_BUFFER=16384;AudioBackendAdapterBase=function(a,b){this._resampleBuffer=new Float32Array,this._channels=a,this._bytesPerSample=b,this._sampleRate=44100,this._inputSampleRate=44100,this._observer,this._manualSetupComplete=!0},AudioBackendAdapterBase.prototype={computeAudioSamples:function(){this.error("computeAudioSamples")},loadMusicData:function(){this.error("loadMusicData")},evalTrackOptions:function(){this.error("evalTrackOptions")},updateSongInfo:function(){this.error("updateSongInfo")},getSongInfoMeta:function(){this.error("getSongInfoMeta")},getAudioBuffer:function(){this.error("getAudioBuffer")},getAudioBufferLength:function(){this.error("getAudioBufferLength")},readFloatSample:function(){this.error("readFloatSample")},applyPanning:function(){this.error("applyPanning")},getBytesPerSample:function(){return this._bytesPerSample},getChannels:function(){return this._channels},isAdapterReady:function(){return!0},mapInternalFilename:function(a,b,c){return(a?a:b)+c},mapUrl:function(a){return a},uploadFile:function(){return 0},isManualSetupComplete:function(){return this._manualSetupComplete},teardown:function(){this.error("teardown")},getMaxPlaybackPosition:function(){return 0},getPlaybackPosition:function(){return 0},seekPlaybackPosition:function(){return-1},getPathAndFilename:function(){this.error("getPathAndFilename")},registerFileData:function(){this.error("registerFileData")},mapBackendFilename:function(a){return a},mapCacheFileName:function(a){return a},handleBackendSongAttributes:function(){this.error("handleBackendSongAttributes")},mapUri2Fs:function(a){var b=a.replace(/\/\//,"\xFD\xFD");return b=b.replace(/\?/,"\xFF"),b=b.replace(/:/,"\xFE"),b=b.replace(/\*/,"\xFC"),b=b.replace(/"/,"\xFB"),b=b.replace(/</,"\xF9"),b=b.replace(/>/,"\xF8"),b=b.replace(/\|/,"\xF7"),b},mapFs2Uri:function(a){var b=a.replace(/ýý/,"//");return b=b.replace(/ÿ/,"?"),b=b.replace(/þ/,":"),b=b.replace(/ü/,"*"),b=b.replace(/û/,"\""),b=b.replace(/ù/,"<"),b=b.replace(/ø/,">"),b=b.replace(/÷/,"|"),b},setObserver:function(a){this._observer=a},notifyAdapterReady:function(){"undefined"!=typeof this._observer&&this._observer.notify()},error:function(a){alert("fatal error: abstract method '"+a+"' must be defined")},resetSampleRate:function(a,b){0<a&&(this._sampleRate=a),0<b&&(this._inputSampleRate=b);var c=Math.round(SAMPLES_PER_BUFFER*this._sampleRate/this._inputSampleRate)*this.getChannels();c>this._resampleBuffer.length&&(this._resampleBuffer=this.allocResampleBuffer(c))},allocResampleBuffer:function(a){return new Float32Array(a)},getCopiedAudio:function(a,b,c,d){var f;for(f=0;f<b*this._channels;f++)d[f]=c(a,f);return b},resampleTickerData:function(a,b){a.resampleData(this._sampleRate,this._inputSampleRate,b,this)},getResampledAudio:function(a,b){return this.getResampledFloats(a,b,this._sampleRate,this._inputSampleRate)},getResampledFloats:function(a,b,c,d){var f;if(c==d)f=this.getCopiedAudio(a,b,this.readFloatSample.bind(this),this._resampleBuffer);else{f=Math.round(b*c/d);var g=f*this._channels;g>this._resampleBuffer.length&&(this._resampleBuffer=this.allocResampleBuffer(g)),this.resampleToFloat(this._channels,0,a,b,this.readFloatSample.bind(this),this._resampleBuffer,f),2==this._channels&&this.resampleToFloat(this._channels,1,a,b,this.readFloatSample.bind(this),this._resampleBuffer,f)}return f},resampleToFloat:function(a,b,c,d,f,g,h){for(var j,k,l=0,m=0,n=h-0,o=d-0,p=Math.abs(n-l),q=l<n?1:-1,r=-Math.abs(o-m),s=m<o?1:-1,t=p+r;;){if(k=l*a+b,g[k]=f(c,m*a+b),l>=n&&m>=o)break;j=2*t,j>r&&(t+=r,l+=q),j<p&&(t+=p,m+=s)}},getResampleBuffer:function(){return this._resampleBuffer}},EmsHEAP16BackendAdapter=function(){var a=function(b,c){a.base.call(this,c,2),this.Module=b,this.Module.adapterCallback=function(){this.doOnAdapterReady(),this.notifyAdapterReady()}.bind(this),window.Math.fround||(window.Math.fround=window.Math.round)};return extend(AudioBackendAdapterBase,a,{doOnAdapterReady:function(){},isAdapterReady:function(){return"undefined"==typeof this.Module.notReady||!this.Module.notReady},registerEmscriptenFileData:function(a,b){try{this.Module.FS_createPath("/",a[0],!0,!0)}catch(a){}var c;try{if("undefined"==typeof this.Module.FS_createDataFile)c=!0;else{c=this.Module.FS_createDataFile(a[0],a[1],b,!0,!0);ScriptNodePlayer.getInstance().trace("registerEmscriptenFileData: ["+a[0]+"]["+a[1]+"] size: "+b.length)}}catch(a){}return c},readFloatSample:function(a,b){return this.Module.HEAP16[a+b]/32768},applyPanning:function(a,b,c){c=256*c/2;var d,f,g,h;for(d=0;d<2*b;d+=2){f=this.Module.HEAP16[a+d],g=this.Module.HEAP16[a+d+1],h=(g-f)*c;var j=(f<<8)+h>>8,k=(g<<8)-h>>8;this.Module.HEAP16[a+d]=j,this.Module.HEAP16[a+d+1]=k}}}),a}(),EmsHEAPF32BackendAdapter=function(){var a=function(b,c){a.base.call(this,b,c),this._bytesPerSample=4};return extend(EmsHEAP16BackendAdapter,a,{readFloatSample:function(a,b){return this.Module.HEAPF32[a+b]},applyPanning:function(a,b,c){c=256*c/2;var d,f,g,h;for(d=0;d<2*b;d+=2){f=this.Module.HEAPF32[a+d],g=this.Module.HEAPF32[a+d+1],h=(g-f)*c;var j=(256*f+h)/256,k=(256*g-h)/256;this.Module.HEAPF32[a+d]=j,this.Module.HEAPF32[a+d+1]=k}}}),a}(),FileCache=function(){this._binaryFileMap={},this._pendingFileMap={},this._isWaitingForFile=!1},FileCache.prototype={getFileMap:function(){return this._binaryFileMap},getPendingMap:function(){return this._pendingFileMap},setWaitingForFile:function(a){this._isWaitingForFile=a},isWaitingForFile:function(){return this._isWaitingForFile},getFile:function(a){var b;return a in this._binaryFileMap&&(b=this._binaryFileMap[a]),b},setFile:function(a,b){this._binaryFileMap[a]=b,this._isWaitingForFile=!1}};var ScriptNodePlayer=function(){return PlayerImpl=function(a,b,c,d,g,h,j,k,l,m){"undefined"==typeof a&&alert("fatal error: backendAdapter not specified"),"undefined"==typeof g&&alert("fatal error: onPlayerReady not specified"),"undefined"==typeof h&&alert("fatal error: onTrackReadyToPlay not specified"),"undefined"==typeof j&&alert("fatal error: onTrackEnd not specified"),"undefined"!=typeof m&&(window.SAMPLES_PER_BUFFER=m),2<a.getChannels()&&alert("fatal error: only 1 or 2 output channels supported"),this._backendAdapter=a,this._backendAdapter.setObserver(this),this._basePath=b,this._traceSwitch=!1,this._spectrumEnabled=d,this._songInfo={},this._onTrackReadyToPlay=h,this._onTrackEnd=j,this._onPlayerReady=g,this._onUpdate=k,this._tickerStepWidth=256,"undefined"!=typeof l&&l.init(SAMPLES_PER_BUFFER,this._tickerStepWidth),this._externalTicker=l,this._maxTicks=window.SAMPLES_PER_BUFFER/this._tickerStepWidth,this._maskTicks=this._maxTicks-1,this._cntTick=0,this._tickToggle=0,this._silenceStarttime=-1,this._silenceTimeout=5,this._sourceBuffer,this._sourceBufferLen,this._numberOfSamplesRendered=0,this._numberOfSamplesToRender=0,this._sourceBufferIdx=0,this._currentPlaytime=0,this._currentTimeout=-1,this.isAutoPlayCripple()||(setGlobalWebAudioCtx(),this._sampleRate=window._gPlayerAudioCtx.sampleRate,this._correctSampleRate=this._sampleRate,this._backendAdapter.resetSampleRate(this._sampleRate,-1)),this._bufferSource,this._gainNode,this._analyzerNode,this._scriptNode,this._freqByteData=0,this._pan=null,window.fileRequestCallback=this.fileRequestCallback.bind(this),window.fileSizeRequestCallback=this.fileSizeRequestCallback.bind(this),window.songUpdateCallback=this.songUpdateCallback.bind(this),this._isPaused=!1,this._isPlayerReady=!1,this._isSongReady=!1,this._initInProgress=!1,this._preLoadReady=!1,window.player=this;var n=window.player.preloadFiles.bind(window.player);n(c,function(){this._preLoadReady=!0,this._preLoadReady&&this._backendAdapter.isAdapterReady()&&this._backendAdapter.isManualSetupComplete()&&(this._isPlayerReady=!0,this._onPlayerReady())}.bind(this))},PlayerImpl.prototype={notify:function(){if("undefined"!=typeof this.deferredPreload&&this._backendAdapter.isAdapterReady()){var a=this.deferredPreload[0],b=this.deferredPreload[1];delete this.deferredPreload,this.preload(a,a.length,b)}!this._isPlayerReady&&this._preLoadReady&&this._backendAdapter.isAdapterReady()&&this._backendAdapter.isManualSetupComplete()&&(this._isPlayerReady=!0,this._onPlayerReady())},handleBackendEvent:function(){this.notify()},isReady:function(){return this._isPlayerReady},setSilenceTimeout:function(a){this._silenceTimeout=a},setTraceMode:function(a){this._traceSwitch=a},play:function(){this._isPaused=!1;try{this._bufferSource.start(0)}catch(a){}},pause:function(){this.isWaitingForFile()||this._initInProgress||!this._isSongReady||(this._isPaused=!0)},isPaused:function(){return this._isPaused},resume:function(){this.isWaitingForFile()||this._initInProgress||!this._isSongReady||this.play()},getBufNum:function(){return Math.ceil(this._cntTick/this._maxTicks)},getCurrentTick:function(){return this._cntTick%this._maskTicks},getTickToggle:function(){return this._tickToggle},getScriptProcessorBufSize:function(){return window.SAMPLES_PER_BUFFER},setVolume:function(a){"undefined"!=typeof this._gainNode&&(this._gainNode.gain.value=a)},getVolume:function(){return"undefined"==typeof this._gainNode?-1:this._gainNode.gain.value},setPanning:function(a){this._pan=a},isStereo:function(){return 2==this._backendAdapter.getChannels()},getSongInfo:function(){return this._songInfo},getSongInfoMeta:function(){return this._backendAdapter.getSongInfoMeta()},setPlaybackTimeout:function(a){this._currentPlaytime=0,this._currentTimeout=0>a?-1:a/1e3*this._correctSampleRate},getPlaybackTimeout:function(){return 0>this._currentTimeout?-1:Math.round(this._currentTimeout/this._correctSampleRate)},getCurrentPlaytime:function(){return this._currentPlaytime/this._correctSampleRate},getFreqByteData:function(){return this._analyzerNode&&(0===this._freqByteData&&(this._freqByteData=new Uint8Array(this._analyzerNode.frequencyBinCount)),this._analyzerNode.getByteFrequencyData(this._freqByteData)),this._freqByteData},getMaxPlaybackPosition:function(){return this._backendAdapter.getMaxPlaybackPosition()},getPlaybackPosition:function(){return this._backendAdapter.getPlaybackPosition()},seekPlaybackPosition:function(a){return this._backendAdapter.seekPlaybackPosition(a)},getCached:function(a,b){var c=(b.basePath?b.basePath:this._basePath)+a,d=this._backendAdapter.mapCacheFileName(c),f=this.getCache().getFile(d);return"undefined"==typeof f?null:f},asyncSetFileData:function(a,b,c){this._fileReadyNotify=a;var d=(b.basePath?b.basePath:this._basePath)+a,f=this._backendAdapter.getPathAndFilename(a),g=this._backendAdapter.registerFileData(f,c);if("undefined"!=typeof g){var h=this._backendAdapter.mapCacheFileName(d);this.getCache().setFile(h,c),this._isSongReady=!1,this.setWaitingForFile(!1),this.initIfNeeded(this.lastUsedFilename,this.lastUsedData,this.lastUsedOptions),this.lastOnCompletion(a)}},loadMusicFromTmpFile:function(a,b,c,d,f){this.initByUserGesture();var g=a.name;this._fileReadyNotify="";var h=(b.basePath?b.basePath:this._basePath)+g;if(!this.loadMusicDataFromCache(h,b,c,d,f)){var j=new FileReader;j.onload=function(){var a=this._backendAdapter.getPathAndFilename(g),k=new Uint8Array(j.result),l=this._backendAdapter.registerFileData(a,k);if("undefined"==typeof l)return void d();var m=this._backendAdapter.mapCacheFileName(h);this.getCache().setFile(m,k),this.prepareTrackForPlayback(h,j.result,b,c,d,f),c(g)}.bind(this),j.onprogress=function(a){f&&f(a.total,a.loaded)}.bind(this),j.readAsArrayBuffer(a)}},isAppleShit:function(){return!!navigator.platform&&/iPad|iPhone|iPod/.test(navigator.platform)},isAutoPlayCripple:function(){return window.chrome||this.isAppleShit()},initByUserGesture:function(){if("undefined"==typeof this._sampleRate)setGlobalWebAudioCtx(),this._sampleRate=window._gPlayerAudioCtx.sampleRate,this._correctSampleRate=this._sampleRate,this._backendAdapter.resetSampleRate(this._sampleRate,-1);else if("suspended"==window._gPlayerAudioCtx.state)try{window._gPlayerAudioCtx.resume()}catch(a){}if("undefined"!=typeof this._bufferSource)try{this._bufferSource.stop(0)}catch(a){}else{var a=window._gPlayerAudioCtx;if(this.isAppleShit()&&this.iOSHack(a),this._analyzerNode=a.createAnalyser(),this._scriptNode=this.createScriptProcessor(a),this._gainNode=a.createGain(),this._scriptNode.connect(this._gainNode),"undefined"!=typeof this._externalTicker){var b=this.createTickerScriptProcessor(a);b.connect(this._gainNode)}this._spectrumEnabled?(this._gainNode.connect(this._analyzerNode),this._analyzerNode.connect(a.destination)):this._gainNode.connect(a.destination),this._bufferSource=a.createBufferSource(),this._bufferSource.start||(this._bufferSource.start=this._bufferSource.noteOn,this._bufferSource.stop=this._bufferSource.noteOff)}},loadMusicFromURL:function(a,b,c,d,f){this.initByUserGesture();var g=this._backendAdapter.mapInternalFilename(b.basePath,this._basePath,a);if(this._fileReadyNotify="",!this.loadMusicDataFromCache(g,b,c,d,f)){var h=new XMLHttpRequest;h.open("GET",this._backendAdapter.mapUrl(g),!0),h.responseType="arraybuffer",h.onload=function(){this.trace("loadMusicFromURL successfully loaded: "+g),this.prepareTrackForPlayback(g,h.response,b,c,d,f)?c(g):!this.isWaitingForFile()&&d()}.bind(this),h.onprogress=function(a){f&&f(a.total,a.loaded)}.bind(this),h.onreadystatuschange=function(){4==oReq.readyState&&404==oReq.status&&this.trace("loadMusicFromURL failed to load: "+g)}.bind(this),h.send(null)}},uploadFile:function(a,b,c,d,f){var g=new FileReader;g.onload=function(){var f=this._backendAdapter.getPathAndFilename(a.name),h=new Uint8Array(g.result),j=this._backendAdapter.registerFileData(f,h);if("undefined"==typeof j)return void d();var k=this._backendAdapter.uploadFile(a.name,b);0===k?(c(a.name),this._onPlayerReady()):1==k&&c(a.name)}.bind(this),g.onprogress=function(a){f&&f(a.total,a.loaded)}.bind(this),g.readAsArrayBuffer(a)},prepareTrackForPlayback:function(a,b,c,d){return this._isPaused=!0,this.lastUsedFilename=a,this.lastUsedData=b,this.lastUsedOptions=c,this.lastOnCompletion=d,this._isSongReady=!1,this.setWaitingForFile(!1),this.initIfNeeded(a,b,c)},trace:function(a){this._traceSwitch&&console.log(a)},setWait:function(a){this.setWaitingForFile(a)},getDefaultSampleRate:function(){return this._correctSampleRate},initIfNeeded:function(a,b,c){"undefined"!=typeof this._externalTicker&&this._externalTicker.reset();var d=this.loadMusicData(a,b,c);if(0>d)this._isSongReady=!1,this.setWaitingForFile(!0),this._initInProgress=!1;else{if(0===d){this.setWaitingForFile(!1),this._isSongReady=!0,this._currentPlaytime=0,this._initInProgress=!1,this.trace("successfully completed init");var f=this._backendAdapter.evalTrackOptions(c);return 0===f?(this.updateSongInfo(a),this.lastUsedFilename==a&&(this._fileReadyNotify==a?this.play():(this._silenceStarttime=-1,this._onTrackReadyToPlay()),this._fileReadyNotify=a),this._isPaused=!1,!0):(this.trace("error preparing track options"),!1)}this._initInProgress=!1,this.trace("initIfNeeded - fatal error")}return!1},loadMusicDataFromCache:function(a,b,c,d,f){this._currentTimeout=-1,this._currentPlaytime=0,this._isPaused=!0;var g=this._backendAdapter.mapCacheFileName(a),h=this.getCache().getFile(g);return"undefined"==typeof h?(this.trace("loadMusicDataFromCache FAILED to find cached file using name: "+g),!1):(this.trace("loadMusicDataFromCache found cached file using name: "+g),this.prepareTrackForPlayback(a,h,b,c,d,f)||this.isWaitingForFile()||d(),!0)},getAudioContext:function(){return this.initByUserGesture(),window._gPlayerAudioCtx},iOSHack:function(){try{var a=window._gPlayerAudioCtx.createBufferSource();a.start||(a.start=a.noteOn,a.stop=a.noteOff),a.buffer=window._gPlayerAudioCtx.createBuffer(1,1,22050),a.connect(window._gPlayerAudioCtx.destination),a.start(0)}catch(a){}},updateSongInfo:function(a){this._songInfo={},this._backendAdapter.updateSongInfo(a,this._songInfo)},loadMusicData:function(a,b,c){if(this._backendAdapter.teardown(),b){var d=this._backendAdapter.getPathAndFilename(a),f=new Uint8Array(b);this._backendAdapter.registerFileData(d,f);var g=this._backendAdapter.mapCacheFileName(a);this.getCache().setFile(g,f);var h=this._backendAdapter.loadMusicData(this._sampleRate,d[0],d[1],f,c);return 0===h&&this.resetBuffer(),h}},resetBuffer:function(){this._numberOfSamplesRendered=0,this._numberOfSamplesToRender=0,this._sourceBufferIdx=0,this._cntTick=0,this._tickToggle=0},resetSampleRate:function(a){this._backendAdapter.resetSampleRate(a,-1),0<a&&(this._sampleRate=a),this.resetBuffer()},createScriptProcessor:function(a){var b=a.createScriptProcessor(SAMPLES_PER_BUFFER,0,this._backendAdapter.getChannels());return b.onaudioprocess=fetchSamples,b},createTickerScriptProcessor:function(a){var b;return b=a.createScriptProcessor(256,0,1),b.onaudioprocess=calcTick,b},fillEmpty:function(a,b,c){var d=a-this._numberOfSamplesRendered;for(i=0;i<d;i++)b[i+this._numberOfSamplesRendered]=0,"undefined"!=typeof c&&(c[i+this._numberOfSamplesRendered]=0);this._numberOfSamplesToRender=0,this._numberOfSamplesRendered=a},fileRequestCallback:function(a){var b=this._backendAdapter.mapBackendFilename(a);return this.trace("fileRequestCallback backend name: "+a+" > FS name: "+b),this.preloadFile(b,function(){this.initIfNeeded(this.lastUsedFilename,this.lastUsedData,this.lastUsedOptions)}.bind(this),!1)},fileSizeRequestCallback:function(a){var b=this._backendAdapter.mapBackendFilename(a),c=this._backendAdapter.mapCacheFileName(b),d=this.getCache().getFile(c);return d.length},songUpdateCallback:function(a){this._backendAdapter.handleBackendSongAttributes(a,this._songInfo),this._onUpdate&&this._onUpdate()},preload:function(a,b,c){if(0===b)c();else{b--;var d=function(){this.preload(a,b,c)}.bind(this);this.preloadFile(a[b],d,!0)}},preloadFile:function(a,b,c){var d=this._backendAdapter.mapCacheFileName(a),g=this.getCache().getFile(d);if("undefined"!=typeof g){var h=0;if(0==g)h=1,this.trace("error: preloadFile could not get cached: "+a);else{this.trace("preloadFile found cached file using name: "+d);var j=this._backendAdapter.getPathAndFilename(a),k=this._backendAdapter.registerFileData(j,g)}return c&&b(),h}if(this.trace("preloadFile FAILED to find cached file using name: "+d),this._isPaused=!0,this.setWaitingForFile(!0),this._isSongReady=!1,!(d in this.getCache().getPendingMap())){this.getCache().getPendingMap()[d]=1;var l=new XMLHttpRequest;l.open("GET",this._backendAdapter.mapUrl(a),!0),l.responseType="arraybuffer",l.onload=function(){var c=l.response;if(c){this.trace("preloadFile successfully loaded: "+a);var g=this._backendAdapter.getPathAndFilename(a),h=new Uint8Array(c),j=this._backendAdapter.registerFileData(g,h);this.trace("preloadFile cached file using name: "+d),this.getCache().setFile(d,h)}delete this.getCache().getPendingMap()[d]||this.trace("remove file from pending failed: "+d),b()}.bind(this),l.onreadystatuschange=function(){4==l.readyState&&404==l.status&&(this.trace("preloadFile failed to load: "+a),this.getCache().setFile(d,0))}.bind(this),l.onerror=function(){this.getCache().setFile(d,0)}.bind(this),l.send(null)}return-1},tick:function(){this._isPaused||this._cntTick++},genSamples:function(a){var b,c=this.isStereo()&&1<a.outputBuffer.numberOfChannels,d=a.outputBuffer.getChannelData(0);if(c&&(b=a.outputBuffer.getChannelData(1)),!this._isSongReady||this.isWaitingForFile()||this._isPaused){var f;for(f=0;f<d.length;f++)d[f]=0,c&&(b[f]=0)}else{"undefined"!=typeof this._externalTicker&&this._externalTicker.start();var g=d.length;for(this._numberOfSamplesRendered=0;this._numberOfSamplesRendered<g;){if(0===this._numberOfSamplesToRender){var h;if(0<this._currentTimeout&&this._currentPlaytime>this._currentTimeout?(this.trace("'song end' forced after "+this._currentTimeout/this._correctSampleRate+" secs"),h=1):(h=this._backendAdapter.computeAudioSamples(),"undefined"!=typeof this._externalTicker&&this._externalTicker.computeAudioSamplesNotify()),0!==h)return this.fillEmpty(g,d,b),0>h?(this._isPaused=!0,this._isSongReady=!1,void this.setWaitingForFile(!0)):this.isWaitingForFile()?void 0:(1<h&&this.trace("playback aborted with an error"),this._isPaused=!0,void(this._onTrackEnd&&this._onTrackEnd()));this._sourceBuffer=this._backendAdapter.getAudioBuffer(),this._sourceBufferLen=this._backendAdapter.getAudioBufferLength(),null!=this._pan&&this._backendAdapter.applyPanning(this._sourceBuffer,this._sourceBufferLen,this._pan+1),this._numberOfSamplesToRender=this._backendAdapter.getResampledAudio(this._sourceBuffer,this._sourceBufferLen),"undefined"!=typeof this._externalTicker&&this._backendAdapter.resampleTickerData(this._externalTicker,this._sourceBufferLen),this._sourceBufferIdx=0}var j=this._backendAdapter.getResampleBuffer();c?this.copySamplesStereo(j,d,b,g):this.copySamplesMono(j,d,g)}this._currentPlaytime+=g*this._correctSampleRate/this._sampleRate,0<this._silenceStarttime&&this._currentPlaytime-this._silenceStarttime>=this._silenceTimeout*this._correctSampleRate&&0<this._silenceTimeout&&(this._isPaused=!0,this._onTrackEnd&&this._onTrackEnd()),"undefined"!=typeof this._externalTicker&&(this._externalTicker.calcTickData(d,b),this._tickToggle=this._tickToggle?0:1)}},detectSilence:function(a){0==this._silenceStarttime?0==a&&(this._silenceStarttime=this._currentPlaytime):0<a&&(this._silenceStarttime=0)},copySamplesStereo:function(a,b,c,d){var f,g=0,h=0,j=0,k=Math.abs;if(this._numberOfSamplesRendered+this._numberOfSamplesToRender>d){var m=d-this._numberOfSamplesRendered;for(f=0;f<m;f++){var n=f+this._numberOfSamplesRendered;"undefined"!=typeof this._externalTicker&&this._externalTicker.copyTickerData(n,this._sourceBufferIdx>>1,this._backendAdapter),h=a[this._sourceBufferIdx++],j=a[this._sourceBufferIdx++],b[n]=h,c[n]=j,g+=k(h)+k(j)}this._numberOfSamplesToRender-=m,this._numberOfSamplesRendered=d}else{for(f=0;f<this._numberOfSamplesToRender;f++){var n=f+this._numberOfSamplesRendered;"undefined"!=typeof this._externalTicker&&this._externalTicker.copyTickerData(n,this._sourceBufferIdx>>1,this._backendAdapter),h=a[this._sourceBufferIdx++],j=a[this._sourceBufferIdx++],b[n]=h,c[n]=j,g+=k(h)+k(j)}this._numberOfSamplesRendered+=this._numberOfSamplesToRender,this._numberOfSamplesToRender=0}this.detectSilence(g)},copySamplesMono:function(a,b,c){var d,f=0,g=0,h=Math.abs;if(this._numberOfSamplesRendered+this._numberOfSamplesToRender>c){var j=c-this._numberOfSamplesRendered;for(d=0;d<j;d++){var k=d+this._numberOfSamplesRendered;"undefined"!=typeof this._externalTicker&&this._externalTicker.copyTickerData(k,this._sourceBufferIdx,this._backendAdapter),g=a[this._sourceBufferIdx++],b[k]=g,f+=h(g)}this._numberOfSamplesToRender-=j,this._numberOfSamplesRendered=c}else{for(d=0;d<this._numberOfSamplesToRender;d++){var k=d+this._numberOfSamplesRendered;"undefined"!=typeof this._externalTicker&&this._externalTicker.copyTickerData(k,this._sourceBufferIdx,this._backendAdapter),g=a[this._sourceBufferIdx++],b[k]=g,f+=h(g)}this._numberOfSamplesRendered+=this._numberOfSamplesToRender,this._numberOfSamplesToRender=0}this.detectSilence(f)},preloadFiles:function(a,b){this._isPaused=!0,this._backendAdapter.isAdapterReady()?this.preload(a,a.length,b):this.deferredPreload=[a,b]},setWaitingForFile:function(a){this.getCache().setWaitingForFile(a)},isWaitingForFile:function(){return this.getCache().isWaitingForFile()},getCache:function(){return"undefined"==typeof window._fileCache&&(window._fileCache=new FileCache),window._fileCache}},{createInstance:function(a,b,c,d,f,g,h,j,k,l){if(null!=k&&"undefined"!=typeof player){_gPlayerAudioCtx.close(),_gPlayerAudioCtx.ctx=null;try{"AudioContext"in window?_gPlayerAudioCtx=new AudioContext:"webkitAudioContext"in window?_gPlayerAudioCtx=new webkitAudioContext:alert(errText+e)}catch(a){alert(errText+a)}}var m=!1;if("undefined"!=typeof window.player){var n=window.player;if(n._isPaused=!0,"undefined"!=typeof n._bufferSource)try{n._bufferSource.stop(0)}catch(a){}n._scriptNode&&n._scriptNode.disconnect(0),n._analyzerNode&&n._analyzerNode.disconnect(0),n._gainNode&&n._gainNode.disconnect(0),m=n._traceSwitch}var o=new PlayerImpl(a,b,c,d,f,g,h,j,k,l);o._traceSwitch=m},getInstance:function(){return"undefined"==typeof window.player&&alert("fatal error: window.player not defined"),window.player}}}();